<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>我是列表页</title>
    <link
      rel="stylesheet"
      href="//at.alicdn.com/t/font_1224930_ax1s5lfwhs9.css"
    />
    <link rel="stylesheet" href="./css/style.css" />
  </head>
  <body>
    <div class="container">
      <div class="com-wrp listp-wrp">
        <div class="title">
          <p>url 列表</p>
          <div class="title-btn">
            <button class="btn">
              <a href="./eidtor.html?time=&status=3&type=create"
                ><i class="iconfont icon-add"></i> 新建</a
              >
            </button>
          </div>
        </div>
        <div id="js_tab" class="list-tab">
          <div class="tab active" data-status="1">待生效</div>
          <div class="tab" data-status="2">已失效</div>
          <div class="tab" data-status="3">生效中</div>
        </div>
        <div id="js_listCont" class="list-cont">
          <!-- <div class="item">
            <a href="./eidtor.html?time=2019-05-20-11&status=1">
              <span class="time">2019-05-20-11</span></a
            >
          </div> -->
        </div>
      </div>
    </div>

    <script src="./js/jquery.3.4.0.min.js"></script>
    <script>
      $(document).ajaxSuccess(function(event, xhr, setting) {
        console.log('111')
        if (xhr.status == 200 && xhr.responseJSON) {
          var statusCode = xhr.responseJSON.code || xhr.responseJSON.result.code
          var resutMsg = xhr.responseJSON.msg || xhr.responseJSON.result.msg
          if (statusCode != 1) {
            alert('出问题了：' + resutMsg)
          }
          if (statusCode == 401) {
            location.href = './login.html'
            return
          }
        }
      })

      var noMoreHtml = '<div class="item tips">就这样了，没有更多了...</div>'
      var loading = '<div class="item tips">我在加载数据...</div>'

      // 构建 dom
      function renderItem(data, status) {
        var arr = []
        if (data) {
          for (var index = 0; index < data.length; index++) {
            var item = data[index]
            var html_ =
              '<div class="item">' +
              '<a href="./eidtor.html?time=' +
              item +
              '&status=' +
              status +
              '">' +
              '<span class="time">' +
              item +
              '</span></a>' +
              '</div>'
            arr.push(html_)
          }
        }
        arr.push(noMoreHtml)
        return arr
      }

      // 获取列表
      function getStatusList(curStatus) {
        var subData = JSON.stringify({
          status: curStatus
        })
        // tips
        $('#js_listCont').html(loading)

        $.ajax({
          url: '/rest/data/pages',
          contentType: 'application/json',
          type: 'POST',
          data: subData
        })
          .then(function(data) {
            if (data.result.code == 1) {
              var html_ = renderItem(data.data, curStatus)

              $('#js_listCont').html(html_)
            }
          })
          .catch(function() {
            alert('出问题了：服务好像挂了！')
          })
      }
      // 默认加载 待生效
      getStatusList($('#js_tab .tab.active').data('status'))

      $(document).on('click', '.tab', function() {
        $(this)
          .addClass('active')
          .siblings()
          .removeClass('active')

        var curStatus = $('#js_tab .tab.active').data('status')
        if (curStatus != 3) {
          getStatusList(curStatus)
        } else {
          // 生效中
          location.href = './eidtor.html?time=&status=3&type=prod'
        }
      })
    </script>
  </body>
</html>
